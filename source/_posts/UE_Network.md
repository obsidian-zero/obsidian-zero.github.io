---
title: UE网络与同步的个人笔记
categories: 
- UE
- Network
tag:
- program
- ue
date: 2024-10-18 00:00:00
updated: 2024-10-18 00:00:00
---

# 前言

个人对UE的网络部分的学习笔记，反映了个人视角中UE的网络部分。

<!-- more -->

# 基本概念

## DS服务器

标准的C-S结构下的服务器，包括玩家本地的客户端和具有权威性的服务端。

DS服务器本身和客户端代码一样的，通过权限控制来明确部分逻辑具体运行的端。

UE是标准的状态同步思路。

> ListenServer较为少见，其即为一个局域网联机的主机端，暂不考虑

## 通信方式

客户端和服务器有两种通信方式：

- 属性复制：对于表明需要复制的属性，服务端会将其同步到客户端上，这是服务器到客户端单向的
- RPC调用：在调用一些代码时，其实际执行的可能在其他端，这是双向皆可的

## 类的网络存在

UE中的类会有四种不同的情况：

| 存在位置                 | 典型例子                          |
| ------------------------ | --------------------------------- |
| 服务器                   | GameMode                          |
| 服务器和所有客户端       | GameState、PlayerState、Character |
| 服务器和仅拥有者的客户端 | PlayerController                  |
| 客户端                   | HUD、UI                           |

## 网络模式 ENetMode

网络模式分成四种：

- **NM_Standalone**：标准的单机，没有服务器
- **NM_DedicatedServer**：DS模式下的服务器
- **NM_ListenServer**：LS模式，局域网联机下的服务器
- **NM_Client**：在有服务器模式下的客户端

## 网络角色 ENetRole

一个Actor在网络复制后、在客户端和远端分别担任一些网络角色

1. **ROLE_None（不存在）**：不存在角色、即没有复制的Actor的远程网络角色为不存在
2. **ROLE_SimulatedProxy（模拟）**：客户端上的角色、即实际控制权不在本客户端上
3. **ROLE_AutonomousProxy（自治）**：客户端上的角色、且实际控制权在本客户端上
4. **ROLE_Authority（权威）**：服务器上的角色一律是权威的

- 复制、服务端就是权威的、客户端是模拟或者自治的
- 不复制、本端就是权威的，其他端的网络角色都是不存在的

> 以上均是主要以本段查看Actor的本地角度，完整见下图

### GetLocalRole()

| 视角\实际归属权 | A客户端控制 | 服务器控制 | B客户端控制 |
| --------------- | ----------- | ---------- | ----------- |
| A客户端         | 自治        | 模拟       | 模拟        |
| B客户端         | 模拟        | 模拟       | 自治        |
| 服务器          | 权威        | 权威       | 权威        |

### GetRemoteRole()

| 视角\实际归属权 | A客户端控制 | 服务器控制 | B客户端控制 |
| --------------- | ----------- | ---------- | ----------- |
| A客户端         | 权威        | 权威       | 权威        |
| B客户端         | 权威        | 权威       | 权威        |
| 服务器          | 自治        | 模拟       | 自治        |


## 本地控制 isLocalController

用来判断这个是否是本地控制的，主要描述以下几个情况：

### controller 通用于AI

1. 单机时、必然为本地
2. 本地是客户端、且本地网络角色为自治、即客户端对自己控制的Actor
3. 本地网络角色为权威、且远程角色不为自治的、即服务器对不归属于客户端的AI、或者客户端对自己本地生成没有复制的

### playerController 仅玩家控制器

1. 本地网络模式为**NM_DedicatedServer** 服务器端、则肯定不是本地的。DS端没有本地玩家。
2. 本地网络模式为**NM_Standalone**或者**NM_Client**，则肯定是本地的，单机没有其他端、客户端则PlayerController只存在本地客户端
3. 本地网络模式为**NM_ListenServer**的，则返回设置好的，因为LS模式下、其他客户端的playerController也会在扮演服务器的客户端存在，因此会由其他地方设计

# 属性复制

将服务器的数据复制到客户端，包括Actor、ActorComponent、各种变量等。UObject也可以复制，但是必须要依托于一个Actor。

## 复制回调

- **蓝图**：蓝图通过**RepNotify**来执行属复制后的回调事件。 
- **C++**：C++通过**ReplicateUsing**宏来标注一个变量在同步后调用的函数。

## 复制条件

可以调整属性复制的条件、减少无端的流量消耗。

| Condition 条件          | 说明                                                     | 实例                                               |
| ----------------------- | -------------------------------------------------------- | -------------------------------------------------- |
| COND_InitialOnly        | 该属性仅在初始数据组尝试发送                             |                                                    |
| COND_OwnerOnly          | 该属性只会发送给Actor的所有者（owner）                   | 一些可能只有玩家自己关心的数据、例如自己的CD倒计时 |
| COND_SkipOwner          | 此属性会发送至除 Owner 之外的所有连接                    |                                                    |
| COND_SimulatedOnly      | 此属性只会发送到模拟Actor（Simulated Actor）             |                                                    |
| COND_AutonomousOnly     | 该属性只会发送给自治Actor(autonomous Actor)              |                                                    |
| COND_SimulatedOrPhysics | 该属性将发送到simulated 或 bRepPhysics Actor。           |                                                    |
| COND_InitialOrOwner     | 该属性将发送初始数据组，或发送给 Actor 的所有者          |                                                    |
| COND_Custom             | 该属性没有特定条件，但需要通过 SetCustomIsActiveOverride |                                                    |

## 使用思路

1. 持久性数据都至少应该保留一个需要复制的对应数据和回调，这样能避免重连的情况下、**RPC**调用不会再次发生导致的数据丢失
2. 不要调用其他对象上需要复制的数据，其他对象可能并未完成复制
3. 只能关注一个接近最新的属性、它的变化过程很有可能丢失

## 常见坑点：

1. 蓝图的回调会在客户端和服务器上调用、而C++的只会在客户端调用，如果需要做变更后逻辑，得在服务器赋值后手动调用
2. C++的回调只会在调用后发现属性值不一致，需要覆盖时调用。如果客户端已经修改成相同值，则不会调用
3. 由于同步需要时间和同步顺序不确定、有可能同步时对象的属性还未能同步，所以最好不要使用其他对象上需要同步的数据

# RPC

即调用函数，但是函数可能在远程其他端执行就是RPC

## 调用和类型

### 类型

RPC存在三种类型：

- **server**：希望只在服务器上调用
- **client**：希望只在对应客户端上调用
- **NetMuticast**：希望在所有端上调用

### 从服务器调用的 RPC

| Actor Ownership | Ownership Status | NetMulticast        | Server | Client                      |
| --------------- | ---------------- | ------------------- | ------ | --------------------------- |
| 被客户端拥有    | 服务器上运行     | 服务器 + 所有客户端 | 服务器 | 在 actor 的所属客户端上运行 |
| 被服务器拥有    | 服务器           | 服务器 + 所有客户端 | 服务器 | 服务器                      |
| 未被拥有        | 服务器           | 服务器 + 所有客户端 | 服务器 | 服务器                      |

### 从客户端调用的RPC

| Actor Ownership        | Ownership Status         | NetMulticast     | Server   | Client           |
| ---------------------- | ------------------------ | ---------------- | -------- | ---------------- |
| 被执行调用的客户端拥有 | 在执行调用的客户端上运行 | 执行调用的客户端 | 服务器上 | 执行调用的客户端 |
| 被不同客户拥有         | 执行调用的客户端         | 执行调用的客户端 | 丢弃     | 执行调用的客户端 |
| 被服务器拥有           | 执行调用的客户端         | 执行调用的客户端 | 丢弃     | 执行调用的客户端 |
| 未被拥有               | 执行调用的客户端         | 执行调用的客户端 | 丢弃     | 执行调用的客户端 |

可以简单理解为，只有客户端调用具备所有权的Actor的ServerRPC，才能逻辑正确的使用

## 可靠性

RPC默认是不可靠的，使用的是UDP，即有可能丢失调用。

只有标记了Reliable宏的RPC才会使用TCP，能保证一定调用到

### 安全验证

**WithValidation**宏指定一个RPC验证函数，在RPC执行前需要验证，只有验证通过才可以执行。

**WithValidation**实际上可以用于Client，Server，NetMulticast的RPC函数，但一般来说还是用在Server的最多，因为一般是Server的数据最权威可以进行数据合法性校验。

## 使用思路

1. RPC 主要作用是执行那些不可靠的暂时性/修饰性游戏事件（不要用RPC来发送持久性状态， 而应该选择使用属性复制）。 这其中包括播放声音、生成粒子或产生其他临时效果之类的事件，它们对于 Actor 的正常运作并不重要。
2. RPC不存在返回值、如果希望有后续结果、需要使用反方向的一个新的RPC调用

## 常见坑点

1. 在遇到“游戏状态恢复”的场景，比如网络游戏中的断线重连。然后你就可能会遇到一些对象在重连后状态不对，因为变化时使用的RPC是一次性的。

   当重连后，RPC不会再执行一次，所以客户端重连的状态与服务器其实是不同的。

   这时候需要使用属性同步来解决问题，但是属性回调在断线重连的时候也并不一定想执行，所以要重新审视一下回调函数里面的内容。

2. 不要大量使用可靠RPC或者Tick中使用rpc，这会导致调用过多堵塞网络。

3. 

# 参考资料

[UE网络精粹](https://www.gamejianghu.cn/post/62793.html#5-RPC-%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8)

[UE网络同步](https://zhuanlan.zhihu.com/p/533754693)

[《Exploring in UE4》关于网络同步的理解与思考[概念理解]](https://zhuanlan.zhihu.com/p/34721113)
